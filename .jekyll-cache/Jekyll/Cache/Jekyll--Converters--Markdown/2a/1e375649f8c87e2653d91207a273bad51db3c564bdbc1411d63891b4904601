I"<p>原本nginx 加了 ….強制轉向到 https</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
listen 80 default_server;
server_name _;
return 301 https://$host$request_uri;
}
</code></pre></div></div>
<p>發生了自動換 key 時</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Checking expiration date for www.test.com...
The certificate for www.test.com is about to expire soon. Starting webroot renewal script...
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Obtaining a new certificate
Performing the following challenges:
http-01 challenge for www.test.com
Using the webroot path /var/www/html for all unmatched domains.
Waiting for verification...
Cleaning up challenges
Failed authorization procedure. www.test.com (http-01): urn:acme:error:unauthorized :: The client lacks sufficient authorization :: Invalid response from http://www.test.com/.well-known/acme-challenge/VKcVMVQ8mMhtovoPoheU6PcVF5kb3MwS7sizRNUWzwk: "<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;&lt;title&gt;</span>404 Not Found<span class="nt">&lt;/title&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">bgcolor=</span><span class="s">"white"</span><span class="nt">&gt;</span>
<span class="nt">&lt;center&gt;&lt;h1&gt;</span>404 Not Found<span class="nt">&lt;/h1&gt;&lt;/center&gt;</span>
<span class="nt">&lt;hr&gt;&lt;center&gt;</span>"

IMPORTANT NOTES:
 - The following errors were reported by the server:

   Domain: www.test.com
   Type:   unauthorized
   Detail: Invalid response from
   http://www.test.com/.well-known/acme-challenge/VKcVMVQ8mMhtovoPoheU6PcVF5kb3MwS7sizRNUWzwk:
   "<span class="nt">&lt;html&gt;</span>
   <span class="nt">&lt;head&gt;&lt;title&gt;</span>404 Not Found<span class="nt">&lt;/title&gt;&lt;/head&gt;</span>
   <span class="nt">&lt;body</span> <span class="na">bgcolor=</span><span class="s">"white"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;center&gt;&lt;h1&gt;</span>404 Not Found<span class="nt">&lt;/h1&gt;&lt;/center&gt;</span>
   <span class="nt">&lt;hr&gt;&lt;center&gt;</span>"

   To fix these errors, please make sure that your domain name was
   entered correctly and the DNS A record(s) for that domain
   contain(s) the right IP address.
</code></pre></div></div>

<p>當然砍到重取 …用 –standalone 也可 ….</p>

<p>不會每次到期就砍掉 …..擺爛的方法 …….</p>

<p>不砍掉用 –standalone  會出現 ……archive directory exists for www.test.com</p>

<p>找到方法了 nginx 設定只要 URL 不是 .well-known 就去轉向到 https</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
        listen 80 default_server;
        server_name _;

    location ~ /\.well-known\/acme-challenge {
        root /var/www/html;
        allow all;
    }
    if ($request_uri !~ /\.well-known) {
        return 301 https://$host$request_uri;
    }
}
</code></pre></div></div>

<p>這樣就 OK 了</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Checking expiration date for www.test.com...
The certificate for www.test.com is about to expire soon. Starting webroot renewal script...
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Obtaining a new certificate
Performing the following challenges:
http-01 challenge for www.test.com
Using the webroot path /var/www/html for all unmatched domains.
Waiting for verification...
Cleaning up challenges

IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at
   /etc/letsencrypt/live/www.test.com-0001/fullchain.pem. Your cert
   will expire on 2017-09-13. To obtain a new or tweaked version of
   this certificate in the future, simply run letsencrypt-auto again.
   To non-interactively renew *all* of your certificates, run
   "letsencrypt-auto renew"
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
Reloading nginx
Renewal process finished for domain www.test.com
</code></pre></div></div>
:ET