I"Á#<h1 id="opencartçš„è·¯ç”±æµç¨‹ä»¥åŠmvcå¦‚ä½•åœ¨opencartä¸­å·¥ä½œ">Opencartçš„è·¯ç”±æµç¨‹ä»¥åŠMVCå¦‚ä½•åœ¨opencartä¸­å·¥ä½œã€‚</h1>

<p>MVCä¸æ˜¯ä¸€å€‹æ‡‰ç”¨ç¨‹åºï¼ŒåŸºæœ¬ä¸Šå®ƒéµå¾ªè¨­è¨ˆæ¨¡å¼ä¸¦åŸºæ–¼åˆ†å±¤æ¶æ§‹ã€‚</p>

<p>MVC (Model View Controller)</p>

<p>Opencart æ¨¡å‹ è¦–åœ– æ§åˆ¶å™¨</p>

<p>æ˜¯ä¸‰å±¤çš„ï¼Œç”¨æ–¼ä»¥æ˜ç¢ºå®šç¾©çš„æ–¹å¼å°‡æ•¸æ“šç›¸äº’å‚³éã€‚</p>

<p><img src="/images/posts/opencart/1.png" /></p>

<p>Controllerï¼šåœ¨Opencart çš„Controlleræ‰®æ¼”èª¿è§£è€…çš„è§’è‰²ï¼Œç®¡ç†æ•´å€‹ç¨‹åºæ§åˆ¶ã€‚</p>

<p>ç•¶ä»»ä½•å®¢æˆ¶é€šéç€è¦½å™¨é»æ“ŠURLæ™‚ï¼Œå°‡èª¿ç”¨æ§åˆ¶å™¨æ–‡ä»¶ã€‚</p>

<p>åœ¨æ§åˆ¶å™¨å…§éƒ¨ï¼Œæˆ‘å€‘å¯ä»¥åŠ è¼‰æ¨¡å‹ä¸¦èª¿ç”¨è©²æ¨¡å‹æ–‡ä»¶çš„æ–¹æ³•ä¾†ç²å–ç›¸é—œæ•¸æ“šã€‚å¾æ¨¡å‹æ–‡ä»¶æ§åˆ¶å™¨ç²å¾—éŸ¿æ‡‰å¾Œï¼Œå°‡æ•¸æ“šç™¼é€åˆ°è¦–åœ–æ–‡ä»¶ã€‚</p>

<p>æˆ‘å€‘é‚„å¯ä»¥åœ¨Opencartçš„æ§åˆ¶å™¨ä¸­åŒ…å«JSå’ŒCSSæ–‡ä»¶ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin/coneroller/{..directory_name..}/{..file_name..}.php
catalog/coneroller/{..directory_name..}/{..file_name..}.php
</code></pre></div></div>

<p>Modelï¼šç”¨æ–¼é€šéä½¿ç”¨SQLæŸ¥è©¢å¾æ•¸æ“šåº«ç²å–æ•¸æ“šä¸¦å°‡ç›¸åŒæ•¸æ“šè¿”å›çµ¦æ§åˆ¶å™¨çš„æ¨¡å‹æ–‡ä»¶ã€‚</p>

<p>æ¨¡å‹æ–‡ä»¶ä¸»è¦ç”¨æ–¼é€šéSQLå‘½ä»¤åŸ·è¡ŒæŸäº›æ“ä½œï¼Œå¦‚DDLï¼ˆæ•¸æ“šå®šç¾©èªè¨€ï¼Œå³å‰µå»ºï¼Œä¿®æ”¹ï¼Œåˆªé™¤ï¼Œæˆªæ–·ç­‰ï¼‰å’ŒDMLï¼ˆæ•¸æ“šæ“ä½œèªè¨€ï¼Œå³é¸æ“‡ï¼Œæ’å…¥ï¼Œæ›´æ–°ï¼Œåˆªé™¤ï¼Œåˆä½µç­‰ï¼‰ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin/model/{..directory_name..}/{..file_name..}.php
catalog/model/{..directory_name..}/{..file_name..}.php
</code></pre></div></div>

<p>Viewï¼šæŸ¥çœ‹æ–‡ä»¶ä»¥phpï¼Œjsonç­‰æ ¼å¼å¾æ§åˆ¶å™¨æ–‡ä»¶æ¥æ”¶çµæœæ•¸æ“šï¼Œä¸¦å°‡è©²æ•¸æ“šæŸ¥çœ‹åˆ°ç€è¦½å™¨ã€‚</p>

<p>æ‚¨å¯ä»¥åœ¨opencartä¸­çš„è¦–åœ–æ–‡ä»¶ä¸­ç·¨å¯«HTMLï¼ŒJS / JQueryï¼ŒCsså’ŒPHPä»£ç¢¼ã€‚</p>

<p>æˆ‘å€‘å°è¦–åœ–æ–‡ä»¶ä½¿ç”¨.tplæ“´å±•ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin/view/template/{..directory_name..}/{..file_name..}.tpl
catalog/view/template/{..template_name,theme_name..}/{..directory_name..}/{..file_name..}.tpl
</code></pre></div></div>

<p>Language: æˆ‘å€‘é‚„ä½¿ç”¨ä¸€å€‹åç‚ºlanguage fileçš„æ–‡ä»¶ä¾†é€²è¡Œèˆ‡æ•¸çµ„ç´¢å¼•çš„stingæ˜ å°„ã€‚</p>

<p>Controlleré€šéä½¿ç”¨å­—ç¬¦ä¸²è½‰æ›ç²å–æ‰€æœ‰ç´¢å¼•ä¸¦å°‡é€™äº›æ•¸çµ„ç´¢å¼•å‘ˆç¾çµ¦.tplæ–‡ä»¶ä¾†åŠ è¼‰æ­¤èªè¨€æ–‡ä»¶ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin/language/{..lanaguage_name..}/{..directory_name..}/{..file_name..}.php
catalog/language/{..lanaguage_name..}/{..directory_name..}/{..file_name..}.php
</code></pre></div></div>

<h2 id="opencartçš„åˆå§‹åŒ–">Opencartçš„åˆå§‹åŒ–</h2>

<p>startup.phpæ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€å€‹åç‚ºmodifyï¼ˆ$ filenameï¼‰çš„æ–¹æ³•ï¼Œåªæœ‰åœ¨ä½¿ç”¨ocmod.xmlæ–‡ä»¶æ™‚æ‰æœƒè¿”å›ä¿®æ”¹æ–‡ä»¶çš„å®Œæ•´åŒ¹é…è·¯å¾‘ï¼š</p>

<p>modification é€™ function</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Modification Override
function modification($filename) {
        if (defined('DIR_CATALOG')) {
                $file = DIR_MODIFICATION . 'admin/' .  substr($filename, strlen(DIR_APPLICATION));
        } elseif (defined('DIR_OPENCART')) {
                $file = DIR_MODIFICATION . 'install/' .  substr($filename, strlen(DIR_APPLICATION));
        } else {
                $file = DIR_MODIFICATION . 'catalog/' . substr($filename, strlen(DIR_APPLICATION));
        }

        if (substr($filename, 0, strlen(DIR_SYSTEM)) == DIR_SYSTEM) {
                $file = DIR_MODIFICATION . 'system/' . substr($filename, strlen(DIR_SYSTEM));
        }

        if (is_file($file)) {
                return $file;
        }

        return $filename;
}
</code></pre></div></div>

<p>åœ¨system / startup.phpæ–‡ä»¶ä¸­æ‰¾åˆ°startï¼ˆâ€™catalogâ€™ï¼‰ï¼Œè©²æ–‡ä»¶å°‡åŠ è¼‰framework.phpæ–‡ä»¶ï¼Œå…¶ä¸­å‰µå»ºæ‰€æœ‰ä½¿ç”¨çš„é¡çš„å°è±¡ä¸¦å°‡å…¶è¨­ç½®ç‚ºè¨»å†Šè¡¨ã€‚</p>

<p>å¯ä»¥é€šéå®ƒè¨ªå•æ§åˆ¶å™¨ä¸­çš„æ‰€æœ‰ç³»çµ±é¡ã€‚</p>

<h2 id="controller-architecture-æ§åˆ¶å™¨æ¶æ§‹">Controller Architecture æ§åˆ¶å™¨æ¶æ§‹</h2>

<p>æ‚¨å°‡æ‰¾åˆ°å¦‚ä¸‹çš„é¡åï¼š ( Controller/Sale/Invoice )</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">ControllerSaleInvoice</span> <span class="k">extends</span> <span class="nx">Controller</span> <span class="p">{</span>
        <span class="k">private</span> <span class="nv">$error</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

        <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">load</span><span class="o">-&gt;</span><span class="na">language</span><span class="p">(</span><span class="s1">'sale/invoice'</span><span class="p">);</span>

                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">document</span><span class="o">-&gt;</span><span class="na">setTitle</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">language</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'heading_title'</span><span class="p">));</span>

                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">load</span><span class="o">-&gt;</span><span class="na">model</span><span class="p">(</span><span class="s1">'sale/invoice'</span><span class="p">);</span>

                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getList</span><span class="p">();</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>åœ¨Caseä¸­ï¼Œæ‚¨æ‡‰å§‹çµ‚é¦–å…ˆç·¨å¯«Controlleré—œéµå­—è€Œä¸æ˜¯ä»»ä½•ç©ºæ ¼ã€‚</p>

<p>åœ¨ä»»ä½•æ§åˆ¶å™¨æ–‡ä»¶ä¸­ï¼Œç´¢å¼•æ–¹æ³•åœ¨é€šéURLå‘½ä¸­æ§åˆ¶å™¨è·¯ç”±æ™‚é¦–å…ˆèª¿ç”¨ã€‚</p>

<p>ä¾‹å¦‚èª¿ç”¨ common/header</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$data['header'] = $this-&gt;load-&gt;controller('common/header');
</code></pre></div></div>
<p>é‚„æ˜¯ common/footer</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$data['footer'] = $this-&gt;load-&gt;controller('common/footer');
</code></pre></div></div>
<p>admin å·¦é¸å–® â€¦ â€˜common/column_left</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$data['column_left'] = $this-&gt;load-&gt;controller('common/column_left');
</code></pre></div></div>

<p>åŠ è¼‰è…³æœ¬å’Œæ ·å¼è¡¨</p>

<p>åœ¨opencartä¸­åŠ è¼‰æ¨£å¼å’Œè…³æœ¬æ–‡ä»¶æœ‰æ–¹æ³•ï¼Œé€šéæ§åˆ¶å™¨åŠ è¼‰é€™äº›æ–‡ä»¶æˆ–åœ¨è¦–åœ–æ–‡ä»¶ï¼ˆ.tplï¼‰ä¸Šå®šç¾©ã€‚</p>

<p>ç›´æ¥åŠ è¼‰ â€¦</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$this-&gt;document-&gt;setTitle($this-&gt;language-&gt;get('heading_title'));
$this-&gt;document-&gt;setTitle($product_info['meta_title']);
$this-&gt;document-&gt;setDescription($product_info['meta_description']);
$this-&gt;document-&gt;setKeywords($product_info['meta_keyword']);
$this-&gt;document-&gt;setType('product');
$this-&gt;document-&gt;setImage($product_info['image']);
$this-&gt;document-&gt;setPrice($this-&gt;tax-&gt;calculate($product_info['price'], $product_info['tax_class_id'], $this-&gt;config-&gt;get('config_tax')));
$this-&gt;document-&gt;addLink($this-&gt;url-&gt;link('product/product', 'product_id=' . $this-&gt;request-&gt;get['product_id']), 'canonical');
$this-&gt;document-&gt;addScript('catalog/view/javascript/jquery/magnific/jquery.magnific-popup.min.js');
$this-&gt;document-&gt;addStyle('catalog/view/javascript/jquery/magnific/magnific-popup.css');
</code></pre></div></div>

<p>åŠ è¼‰model</p>

<p>æ§åˆ¶å™¨ä¸ŠåŠ è¼‰æ¨¡å‹ï¼Œä¸¦å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤èª¿ç”¨æ¨¡å‹å‡½æ•¸ï¼š</p>

<p>åŠ è¼‰æ¨¡å‹å…¨éƒ¨(sale/invoice) æˆ–å–®ä¸€å€‹ (catalog/information å…§ InformationLayouts çš„ information_id â€¦  public function getInformation($information_id )</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$this-&gt;load-&gt;model('sale/invoice');
$data['information_layout'] = $this-&gt;model_catalog_information-&gt;getInformationLayouts($this-&gt;request-&gt;get['information_id']);
</code></pre></div></div>

<p>æ¨¡æ¿ï¼ˆè¦–åœ–ï¼‰æ–‡ä»¶</p>

<p>controller ç™¼é€ or æŸ¥çœ‹æ•¸æ“šåˆ°viewï¼ˆ.tplï¼‰æ–‡ä»¶ï¼Œä½¿ç”¨ä»¥ä¸‹ä»£ç¢¼ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># use module controller , use as
return $this-&gt;load-&gt;view('common/header', $data);

# use layout controller , use as
$this-&gt;response-&gt;setOutput($this-&gt;load-&gt;view('catalog/product_list', $data));
</code></pre></div></div>

<p>controller å›æ‡‰ json</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$this-&gt;response-&gt;setOutput(json_encode($json));
</code></pre></div></div>

:ET