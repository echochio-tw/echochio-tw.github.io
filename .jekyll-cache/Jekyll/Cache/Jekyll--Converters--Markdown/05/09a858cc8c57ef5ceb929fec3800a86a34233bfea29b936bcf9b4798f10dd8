I"ß<p>å°‡åŸæœ¬çš„æœå‹™çš„ port ä¾‹å¦‚ 443 æ”¹æˆ 4443</p>

<p>å†ç”± nginx proxy å»ç€è¦½ 4443 ç„¶è€Œå°å¤–çš„æ˜¯ nginx 443 port , nginx ç”¨ http/2.0</p>

<p>é€™æ¨£ ä¸ç®¡å¾Œå°æ˜¯å•¥éƒ½è®Šæˆ  http/2.0 äº†</p>

<p>centos è£ nginx</p>

<p>ç·¨è¼¯ /etc/yum.repos.d/nginx.repo</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=0
enabled=1
</code></pre></div></div>

<p>å®‰è£ ngnix</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install nginx
</code></pre></div></div>

<p>ç·¨è¼¯ /etc/nginx/conf.d/default.conf (ä¸»æ©Ÿæ˜¯ http://ssl.demo.com  è®Š 443 )</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
    listen       443 ssl http2;
    server_name  eip.enlicom.com;
    ssl_certificate    /etc/letsencrypt/live/ssl.demo.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ssl.demo.com/privkey.pem;
    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 5m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:ECDHE-RSA-DES-CBC3-SHA:ECDHE-ECDSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA;
    ssl_prefer_server_ciphers on;
    ssl_dhparam /etc/pki/tls/dhparams.pem;
    resolver 8.8.8.8;
     location / {
        add_header X-Proxy-Cache    $upstream_cache_status;
        proxy_pass                  http://ssl.demo.com;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_read_timeout  90;
        proxy_redirect      http://ssl.demo.com https://ssl.demo.com;
        sub_filter_types text/xml text/css *;
        sub_filter 'http://'  'https://';
        sub_filter_once off;
    }
     location ~ /.well-known {
        allow all;
    }
}
</code></pre></div></div>

<p>å…¶ä¸­ â€¦.
æ›´æ”¹ä¸‹é¢æ–‡ä»¶å­—ä¸² â€¦.æœ€å¾Œé‚£æ˜¯ â€œæ˜Ÿè™Ÿâ€ æ˜¯æŒ‡å…¨éƒ¨ â€¦..</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> sub_filter_types text/xml text/css *;
</code></pre></div></div>

<p>å°‡ http://ssl.demo.com æ›æˆ https://ssl.demo.com
(è¦çœ‹éœ€æ±‚ â€¦.æˆ–è¨±ç”¨ http:// æ›æˆ https:// å…ˆæ¸¬è©¦æ¯”è¼ƒå¥½)
é€™èˆ‡ linux sed åŠŸèƒ½å¾ˆåƒ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sub_filter 'http://ssl.demo.com'  'https://ssl.demo.com';
</code></pre></div></div>

<p>åªæ›ç¬¬ä¸€å€‹æ‰¾åˆ°çš„ å­—ä¸²æ›´æ›</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sub_filter_once off;
</code></pre></div></div>

<p>é€™æ®µæ˜¯çµ¦æˆ‘çš„ certificate renew ç”¨çš„ â€¦..</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> location ~ /.well-known {
        allow all;
}
</code></pre></div></div>

<p>é‚„éœ€æ³¨æ„çš„æ˜¯ å¾Œç«¯å‚³ä¾†çš„æ–‡ä»¶ä¸èƒ½æ˜¯å£“ç¸®éçš„ä¾‹å¦‚ gzip æ–‡ä»¶ , å£“ç¸®éçš„ gzip æ–‡ä»¶ sub_filter ä¸èƒ½è™•ç†
è™•ç†æ–¹å¼åŠ </p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxy_set_header Accept-Encoding "";
</code></pre></div></div>

<p>åŸæœ¬æ˜¯ :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># /usr/local/bin/curl --http2 -I --insecure https://ssl.demo.com
HTTP/1.1 200 OK
Date: Wed, 17 May 2017 08:25:07 GMT
Server: Apache/2.2.15 (CentOS)
Last-Modified: Wed, 17 May 2017 07:32:24 GMT
ETag: "2c0b72-9-54fb34a123200"
Accept-Ranges: bytes
Content-Length: 9
Connection: close
Content-Type: text/html; charset=UTF-8 
</code></pre></div></div>

<p>è®Šæˆ :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># /usr/local/bin/curl --http2 -I --insecure https://ssl.demo.com
HTTP/2.0 200
server:nginx/1.12.0
date:Wed, 17 May 2017 08:45:06 GMT
content-type:text/html; charset=UTF-8
content-length:9
last-modified:Wed, 17 May 2017 07:32:24 GMT
etag:"2c0b72-9-54fb34a123200"
accept-ranges:bytes
</code></pre></div></div>

:ET