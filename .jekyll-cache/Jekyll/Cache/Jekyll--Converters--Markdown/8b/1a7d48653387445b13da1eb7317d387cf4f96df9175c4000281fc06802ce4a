I"/<p>這要配合 vCenter …. XD</p>

<ol>
  <li>要寫個 BAT 叫 ……vm-snap.bat  好了</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#echo off

Title,Report Script &amp;color 9e
for /f "usebackq delims=$" %%a in (`cd`) do (
  set SCRIPTDIR=%%a
)

(Set ScriptFile=C:\script\VM_SNAP.ps1 )

C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -psc "C:\Program Files (x86)\VMware\Infrastructure\vSphere PowerCLI\vim.psc1" -noe -c ". \"C:\Program Files (x86)\VMware\Infrastructure\vSphere PowerCLI\Scripts\Initialize-PowerCLIEnvironment.ps1\"";%ScriptFile%"
</code></pre></div></div>

<ol>
  <li>寫 VM_SNAP.ps1</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># snap VM
# [ON LINE] VMH
# Eat Params
$doVMname = '`[ON LINE`] VMH'
$vCenterName = "192.168.0.200"
$filenameFormat = "VMH" + (get-date -Format "yyyy-MM-dd")
$delfilenameFormat = "VMH" + (get-date (get-date).addDays(-3) -Format "yyyy-MM-dd")

# Load Powershell snapin from VMware
# ignore all errors
Add-PSSnapin VMware.VimAutomation.Core -ErrorAction SilentlyContinue

# Connect ESX/vCenter Server
connect-viserver $vCenterName

$VMF = Get-VM $doVMname

# juet test get snapshot list for $doVMname
get-snapshot -vm $VMF

# take snapshoot
New-snapshot -VM $VMF -name $filenameFormat -Quiesce -Memory

# del old snapshoot
get-snapshot -VM $VMF -name $delfilenameFormat |  remove-snapshot  -confirm:$false
</code></pre></div></div>

<ol>
  <li>vm-snap.bat  放到排程 …設成不登入與否都要執行 ….</li>
</ol>
:ET