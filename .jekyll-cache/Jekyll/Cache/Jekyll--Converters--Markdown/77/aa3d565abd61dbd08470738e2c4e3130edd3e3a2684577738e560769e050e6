I"®:<p>åªæ˜¯è©¦é©—ç·´ç¨‹å¼ â€¦.ä¸æœƒä¸Šç·šå•¦</p>

<p><img src="/images/posts/perl/p1.png" /></p>

<p>å°‡äººå®¶å¯«å¥½çš„æ”¹ä¸€æ”¹â€¦. åŠ äº†   $shttp &amp; $dhttp å…©å€‹è®Šæ•¸åŠæ›¿æ›   $buffer =~ s/$shttp/$dhttp/g;
è¦çœ‹æ›¿æ›é‚£äº›æˆ–è¨±é‚„æœ‰ http://test2.com.tw è¦æ› â€¦â€¦å“ˆå“ˆ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/perl</span>
<span class="c1">#</span>
<span class="c1"># Peteris Krumins (peter@catonmat.net)</span>
<span class="c1"># http://www.catonmat.net  --  good coders code, great reuse</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># Written for the article "A TCP Proxy in Perl":</span>
<span class="c1">#</span>
<span class="c1"># http://catonmat.net/blog/perl-tcp-proxy</span>
<span class="c1">#</span>

<span class="k">use</span> <span class="nv">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="nv">strict</span><span class="p">;</span>

<span class="k">use</span> <span class="nn">IO::Socket::</span><span class="nv">INET</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IO::</span><span class="nv">Select</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">@allowed_ips</span> <span class="o">=</span> <span class="p">('</span><span class="s1">all</span><span class="p">',</span> <span class="p">'</span><span class="s1">10.10.10.5</span><span class="p">');</span>
<span class="k">my</span> <span class="nv">$ioset</span> <span class="o">=</span> <span class="nn">IO::</span><span class="nv">Select</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
<span class="k">my</span> <span class="o">%</span><span class="nv">socket_map</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$shttp</span> <span class="o">=</span> <span class="p">"</span><span class="s2">http://test.com.tw</span><span class="p">";</span>
<span class="k">my</span> <span class="nv">$dhttp</span> <span class="o">=</span> <span class="p">"</span><span class="s2">https://test.com.tw</span><span class="p">";</span>

<span class="k">my</span> <span class="nv">$debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">new_conn</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">return</span> <span class="nn">IO::Socket::</span><span class="nv">INET</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="nv">PeerAddr</span> <span class="o">=&gt;</span> <span class="nv">$host</span><span class="p">,</span>
        <span class="nv">PeerPort</span> <span class="o">=&gt;</span> <span class="nv">$port</span>
    <span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="p">"</span><span class="s2">Unable to connect to </span><span class="si">$host</span><span class="s2">:</span><span class="si">$port</span><span class="s2">: $!</span><span class="p">";</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">new_server</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$server</span> <span class="o">=</span> <span class="nn">IO::Socket::</span><span class="nv">INET</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="nv">LocalAddr</span> <span class="o">=&gt;</span> <span class="nv">$host</span><span class="p">,</span>
        <span class="nv">LocalPort</span> <span class="o">=&gt;</span> <span class="nv">$port</span><span class="p">,</span>
        <span class="nv">ReuseAddr</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nv">Listen</span>    <span class="o">=&gt;</span> <span class="mi">100</span>
    <span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="p">"</span><span class="s2">Unable to listen on </span><span class="si">$host</span><span class="s2">:</span><span class="si">$port</span><span class="s2">: $!</span><span class="p">";</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">new_connection</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$server</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$remote_host</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$remote_port</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$client</span> <span class="o">=</span> <span class="nv">$server</span><span class="o">-&gt;</span><span class="nb">accept</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$client_ip</span> <span class="o">=</span> <span class="nv">client_ip</span><span class="p">(</span><span class="nv">$client</span><span class="p">);</span>

    <span class="k">unless</span> <span class="p">(</span><span class="nv">client_allowed</span><span class="p">(</span><span class="nv">$client</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">print</span> <span class="p">"</span><span class="s2">Connection from </span><span class="si">$client_ip</span><span class="s2"> denied.</span><span class="se">\n</span><span class="p">"</span> <span class="k">if</span> <span class="nv">$debug</span><span class="p">;</span>
        <span class="nv">$client</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">print</span> <span class="p">"</span><span class="s2">Connection from </span><span class="si">$client_ip</span><span class="s2"> accepted.</span><span class="se">\n</span><span class="p">"</span> <span class="k">if</span> <span class="nv">$debug</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$remote</span> <span class="o">=</span> <span class="nv">new_conn</span><span class="p">(</span><span class="nv">$remote_host</span><span class="p">,</span> <span class="nv">$remote_port</span><span class="p">);</span>
    <span class="nv">$ioset</span><span class="o">-&gt;</span><span class="nv">add</span><span class="p">(</span><span class="nv">$client</span><span class="p">);</span>
    <span class="nv">$ioset</span><span class="o">-&gt;</span><span class="nv">add</span><span class="p">(</span><span class="nv">$remote</span><span class="p">);</span>

    <span class="nv">$socket_map</span><span class="p">{</span><span class="nv">$client</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$remote</span><span class="p">;</span>
    <span class="nv">$socket_map</span><span class="p">{</span><span class="nv">$remote</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$client</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">close_connection</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$client</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$client_ip</span> <span class="o">=</span> <span class="nv">client_ip</span><span class="p">(</span><span class="nv">$client</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$remote</span> <span class="o">=</span> <span class="nv">$socket_map</span><span class="p">{</span><span class="nv">$client</span><span class="p">};</span>

    <span class="nv">$ioset</span><span class="o">-&gt;</span><span class="nv">remove</span><span class="p">(</span><span class="nv">$client</span><span class="p">);</span>
    <span class="nv">$ioset</span><span class="o">-&gt;</span><span class="nv">remove</span><span class="p">(</span><span class="nv">$remote</span><span class="p">);</span>

    <span class="nb">delete</span> <span class="nv">$socket_map</span><span class="p">{</span><span class="nv">$client</span><span class="p">};</span>
    <span class="nb">delete</span> <span class="nv">$socket_map</span><span class="p">{</span><span class="nv">$remote</span><span class="p">};</span>

    <span class="nv">$client</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">;</span>
    <span class="nv">$remote</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">;</span>

    <span class="k">print</span> <span class="p">"</span><span class="s2">Connection from </span><span class="si">$client_ip</span><span class="s2"> closed.</span><span class="se">\n</span><span class="p">"</span> <span class="k">if</span> <span class="nv">$debug</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">client_ip</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$client</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">inet_ntoa</span><span class="p">(</span><span class="nv">$client</span><span class="o">-&gt;</span><span class="nv">sockaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">client_allowed</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$client</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$client_ip</span> <span class="o">=</span> <span class="nv">client_ip</span><span class="p">(</span><span class="nv">$client</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">grep</span> <span class="p">{</span> <span class="nv">$_</span> <span class="ow">eq</span> <span class="nv">$client_ip</span> <span class="o">||</span> <span class="nv">$_</span> <span class="ow">eq</span> <span class="p">'</span><span class="s1">all</span><span class="p">'</span> <span class="p">}</span> <span class="nv">@allowed_ips</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">die</span> <span class="p">"</span><span class="s2">Usage: $0 &lt;local port&gt; &lt;remote_host:remote_port&gt;</span><span class="p">"</span> <span class="k">unless</span> <span class="nv">@ARGV</span> <span class="o">==</span> <span class="mi">2</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$local_port</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$remote_host</span><span class="p">,</span> <span class="nv">$remote_port</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span> <span class="p">'</span><span class="s1">:</span><span class="p">',</span> <span class="nb">shift</span><span class="p">();</span>


<span class="k">print</span> <span class="p">"</span><span class="s2">Starting a server on 0.0.0.0:</span><span class="si">$local_port</span><span class="se">\n</span><span class="p">";</span>
<span class="k">my</span> <span class="nv">$server</span> <span class="o">=</span> <span class="nv">new_server</span><span class="p">('</span><span class="s1">0.0.0.0</span><span class="p">',</span> <span class="nv">$local_port</span><span class="p">);</span>
<span class="nv">$ioset</span><span class="o">-&gt;</span><span class="nv">add</span><span class="p">(</span><span class="nv">$server</span><span class="p">);</span>

<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="k">my</span> <span class="nv">$socket</span> <span class="p">(</span><span class="nv">$ioset</span><span class="o">-&gt;</span><span class="nv">can_read</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$socket</span> <span class="o">==</span> <span class="nv">$server</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">new_connection</span><span class="p">(</span><span class="nv">$server</span><span class="p">,</span> <span class="nv">$remote_host</span><span class="p">,</span> <span class="nv">$remote_port</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">next</span> <span class="k">unless</span> <span class="nb">exists</span> <span class="nv">$socket_map</span><span class="p">{</span><span class="nv">$socket</span><span class="p">};</span>
            <span class="k">my</span> <span class="nv">$remote</span> <span class="o">=</span> <span class="nv">$socket_map</span><span class="p">{</span><span class="nv">$socket</span><span class="p">};</span>
            <span class="k">my</span> <span class="nv">$buffer</span><span class="p">;</span>
            <span class="k">my</span> <span class="nv">$read</span> <span class="o">=</span> <span class="nv">$socket</span><span class="o">-&gt;</span><span class="nb">sysread</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$read</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$buffer</span> <span class="o">=~</span> <span class="sr">s/$shttp/$dhttp/g</span><span class="p">;</span>
                <span class="c1"># print $buffer."\n";</span>
                <span class="nv">$remote</span><span class="o">-&gt;</span><span class="nb">syswrite</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nv">close_connection</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç”¨ golang ä¹Ÿå¯ â€¦æˆ‘é‚„æ²’è©¦ â€¦
https://github.com/jpillora/go-tcp-proxy</p>
:ET